# دليل تحويل المشروع من MongoDB إلى Supabase

## نظرة عامة

تم تحويل مشروع Smart Coin من استخدام MongoDB كقاعدة بيانات إلى استخدام Supabase. يوفر هذا الدليل معلومات حول التغييرات التي تمت والخطوات اللازمة لتشغيل المشروع بعد التحويل.

## التغييرات الرئيسية

1. **إزالة اعتماديات MongoDB**:
   - تمت إزالة حزمة `mongoose` من ملفات `package.json`
   - تمت إزالة كود الاتصال بـ MongoDB من `server.js`
   - تمت إزالة نماذج MongoDB من مجلد `models`

2. **إضافة Supabase**:
   - تمت إضافة حزمة `@supabase/supabase-js` إلى ملفات `package.json`
   - تم إنشاء ملفات اتصال Supabase في مجلدات `config`
   - تم تحديث ملفات `.env` لإضافة متغيرات Supabase

3. **هيكلة جديدة للمشروع**:
   - تم إنشاء مجلد `services` يحتوي على خدمات منفصلة لكل وظيفة
   - تم تحديث ملفات المسارات لاستخدام هذه الخدمات
   - تم إنشاء ملفات اختبار للتحقق من صحة الاتصال والوظائف

## هيكل قاعدة البيانات في Supabase

تم إنشاء الجداول التالية في Supabase:

1. **جدول المستخدمين (users)**
2. **جدول المعاملات (transactions)**
3. **جدول المدفوعات (payments)**
4. **جدول حزم التعدين (mining_packages)**
5. **جدول بطاقات المتجر (store_cards)**
6. **جدول محافظ TON (ton_wallets)**
7. **جدول مستويات VIP (vip_levels)**

## متطلبات التشغيل

1. **متغيرات البيئة**:
   يجب تكوين المتغيرات التالية في ملف `.env`:

   ```
   # رابط Supabase وواجهة برمجة التطبيقات
   SUPABASE_URL=https://nffihuiiipxoomvagprc.supabase.co
   SUPABASE_KEY=public-anon-key
   ```

2. **تثبيت الاعتماديات**:
   ```
   cd backend
   npm install
   
   cd ../telegram-bot
   npm install
   ```

3. **اختبار الاتصال**:
   ```
   cd backend
   node test-connection.js
   ```

## الخدمات المتاحة

تم تنظيم الكود في خدمات منفصلة لتسهيل الصيانة والتطوير:

1. **خدمة المستخدمين (userService)**:
   - إنشاء مستخدم جديد
   - الحصول على مستخدم بواسطة اسم المستخدم أو المعرف
   - تحديث بيانات المستخدم
   - إعادة تعيين التعدين اليومي
   - التحقق من انتهاء صلاحية الحزمة
   - التحقق من أهلية السحب

2. **خدمة المعاملات (transactionService)**:
   - إنشاء معاملة جديدة
   - الحصول على معاملات المستخدم
   - تحديث حالة المعاملة

3. **خدمة المحفظة (walletService)**:
   - تحويل عملات بين المستخدمين
   - طلب سحب العملات
   - الحصول على معاملات المحفظة

4. **خدمة التعدين (miningService)**:
   - بدء وإيقاف عملية التعدين
   - شراء حزم التعدين
   - الحصول على إحصائيات التعدين

5. **خدمة الإحالة (referralService)**:
   - الحصول على رابط الإحالة
   - معالجة الإحالات
   - الحصول على إحصائيات الإحالة

## ملاحظات هامة

1. **قواعد الأمان**:
   - تم تنفيذ قواعد أمان على مستوى الصف (Row Level Security) في Supabase
   - يجب التأكد من تكوين هذه القواعد في لوحة تحكم Supabase

2. **الوظائف والمشغلات**:
   - تم تنفيذ الوظائف والمشغلات اللازمة في Supabase
   - يمكن الاطلاع على هذه الوظائف في ملف `supabase_implementation_plan.md`

3. **الترحيل من MongoDB**:
   - لم يتم ترحيل البيانات من MongoDB إلى Supabase
   - يمكن استخدام أدوات مثل `pg_dump` و`pg_restore` لترحيل البيانات إذا لزم الأمر

## الاختبار

تم إنشاء ملفات اختبار للتحقق من صحة التنفيذ:

1. **اختبار الاتصال**:
   ```
   node test-connection.js
   ```

2. **اختبار الوظائف**:
   ```
   node test-functions.js
   ```

## المساهمون

- فريق تطوير Smart Coin

## الترخيص

جميع الحقوق محفوظة © 2025 Smart Coin
